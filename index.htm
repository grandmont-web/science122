<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸€å¹´ç´šç§‘å­¸ç§‘ ç¬¬äºŒå­¸æ®µ è©•ä¼°ä¸‰</title>
    <style>
        :root {
            --primary-color: #5C9CE6;
            --primary-dark: #357ABD;
            --success-color: #81C784;
            --bg-color: #EBF4FA;
            --card-bg: #FFFFFF;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overscroll-behavior: none; 
            touch-action: pan-y;
        }

        * {
            -webkit-user-select: none;
            user-select: none;
            box-sizing: border-box;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #64B5F6, #1976D2);
            color: white;
            padding: 15px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            position: relative; /* ç‚ºäº†å®šä½ç™»å‡ºæŒ‰éˆ• */
        }

        h1 { margin: 0; font-size: 1.6em; }
        h2 { margin: 5px 0 0 0; font-size: 1.1em; opacity: 0.95; }

        /* ç™»å‡ºæŒ‰éˆ•æ¨£å¼ */
        .logout-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: #FF5252;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none; /* é è¨­éš±è—ï¼Œç™»å…¥å¾Œé¡¯ç¤º */
        }
        .logout-btn:active { transform: scale(0.95); background-color: #D32F2F; }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 800px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .hidden { display: none !important; }

        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-color); font-size: 1.1em; }
        select, input {
            width: 100%; padding: 15px; font-size: 1.1em;
            border: 2px solid #B0BEC5; border-radius: 12px;
            background: #FAFAFA;
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 1.4rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 6px 15px rgba(74, 144, 226, 0.3);
            transition: transform 0.1s;
            width: 100%;
            max-width: 300px;
            margin-top: 10px;
        }
        .btn:active { transform: scale(0.95); background-color: var(--primary-dark); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #E1F5FE;
            padding: 12px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-weight: bold;
            color: #0277BD;
            font-size: 1.2em;
        }

        .instruction { 
            font-size: 1.5em; 
            margin-bottom: 25px; 
            color: #444; 
            line-height: 1.4;
        }

        .play-area {
            display: flex;
            flex-direction: column;
            gap: 25px;
            min-height: 450px;
        }

        .buckets-container {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            flex-wrap: nowrap;
        }

        .bucket {
            flex: 1;
            min-width: 45%;
            border: 4px dashed #BDBDBD;
            border-radius: 20px;
            background: #FAFAFA;
            padding: 15px 10px;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: all 0.2s;
        }
        
        .bucket.active-drop {
            background-color: #C8E6C9;
            border-color: #2E7D32;
            border-style: solid;
            box-shadow: 0 0 15px rgba(46, 125, 50, 0.3);
            transform: scale(1.02);
        }

        .bucket-label {
            font-size: 1.6em; 
            font-weight: bold; 
            color: #555;
            margin-bottom: 15px; 
            background: #fff; 
            padding: 8px 20px;
            border-radius: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 90%;
            border: 1px solid #eee;
            pointer-events: none;
        }

        .ordering-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 10px;
            margin: 10px 0;
            background: #F5F5F5;
            padding: 20px 10px;
            border-radius: 20px;
        }
        
        .order-slot {
            flex: 1;
            height: 180px;
            border: 3px solid #CFD8DC;
            border-radius: 15px;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            transition: all 0.2s;
        }
        
        .order-slot.active-drop {
            background-color: #BBDEFB;
            border-color: #1565C0;
            box-shadow: inset 0 0 15px rgba(21, 101, 192, 0.2);
            transform: scale(1.02);
        }

        .slot-label {
            position: absolute; bottom: -35px; 
            font-weight: bold; color: #666; width: 100%;
            font-size: 1.2em;
            pointer-events: none;
        }
        
        .arrow-indicator {
            font-size: 1.5em; color: #B0BEC5; margin: 0 2px;
            align-self: center;
        }

        .items-pool {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            padding: 25px;
            background: #FFF8E1;
            border-radius: 20px;
            min-height: 220px;
            align-items: flex-start;
            border: 2px solid #FFE082;
        }

        .draggable {
            width: 170px; height: 210px;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 6px 10px rgba(0,0,0,0.08);
            z-index: 10;
            position: relative;
            touch-action: none; 
            transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .draggable.dragging {
            opacity: 0.7;
            transform: scale(1.1);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: none;
        }

        .draggable-icon {
            width: 120px;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 8px;
            overflow: hidden;
            pointer-events: none;
        }

        .draggable-icon svg, .draggable-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            pointer-events: none;
            filter: drop-shadow(2px 3px 2px rgba(0,0,0,0.1));
        }

        .item-text-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.2;
            width: 100%;
            pointer-events: none;
        }

        .item-name {
            font-size: 28px;
            color: #212121;
            font-weight: 800;
            margin-top: 4px;
        }

        .item-eng {
            font-size: 18px; 
            color: #546E7A;
            margin-top: 4px;
            font-weight: 600;
        }
        
        .draggable.placed { 
            margin: 0; 
            width: 100%; height: 100%;
            border: none;
            background: transparent;
            box-shadow: none;
            position: static;
            transform: none;
        }
        
        .draggable.placed .draggable-icon { width: 80px; height: 80px; margin-bottom: 0;}
        .draggable.placed .item-name { font-size: 18px; } 
        .draggable.placed .item-eng { display: none; }

        .result-score { font-size: 5em; color: var(--primary-color); font-weight: bold; margin: 20px 0; }
        .result-table {
            width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px;
            border-radius: 10px; overflow: hidden;
            border: 1px solid #ddd;
        }
        .result-table th, .result-table td {
            padding: 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 1.2em;
        }
        .result-table th { background: #E3F2FD; color: #1565C0; }
        
        .details-container {
            margin-top: 30px;
            width: 100%;
            text-align: left;
        }
        .details-title { font-size: 1.5em; color: #333; margin-bottom: 10px; border-left: 5px solid var(--primary-color); padding-left: 10px; }
        .details-table {
            width: 100%; border-collapse: collapse;
        }
        .details-table th, .details-table td {
            padding: 10px; border: 1px solid #eee; text-align: center;
        }
        .details-table th { background: #f9f9f9; color: #555; }
        .ans-correct { color: #4CAF50; font-weight: bold; }
        .ans-wrong { color: #F44336; font-weight: bold; }
        
        .lock-control {
            margin: 20px 0;
            padding: 15px;
            background-color: #FFF3E0;
            border: 2px solid #FFCC80;
            border-radius: 15px;
            display: inline-block;
            width: 100%;
            max-width: 300px;
        }
        .lock-control label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            cursor: pointer;
            color: #E65100;
        }
        .lock-control input {
            width: 25px;
            height: 25px;
            margin-right: 10px;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); display: none;
            justify-content: center; align-items: center; z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .modal {
            background: white; padding: 40px; border-radius: 30px;
            text-align: center; max-width: 500px; width: 90%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from {transform: scale(0.5); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        #upload-status {
            margin-top: 10px;
            color: #666;
            font-style: italic;
            height: 20px;
            font-weight: bold;
        }

        .password-icon {
            font-size: 3em;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

    </style>
</head>
<body>

    <header>
        <h1>ä¸€å¹´ç´šç§‘å­¸ç§‘</h1>
        <h2>ç¬¬äºŒå­¸æ®µ é€²è©•ä¸‰ï¼šç”Ÿæ´»ç‰©å“ç‰¹æ€§çš„è¾¨è­˜</h2>
        <!-- ç™»å‡ºæŒ‰éˆ• -->
        <button id="logout-btn" class="logout-btn" onclick="logout()">ç™»å‡º</button>
    </header>

    <!-- 0. å¯†ç¢¼é é¢ -->
    <div id="password-screen" class="card">
        <div class="password-icon">ğŸ”’</div>
        <h2>è«‹è¼¸å…¥è©•ä¼°å¯†ç¢¼</h2>
        <div class="form-group">
            <label for="password-input">å¯†ç¢¼</label>
            <input type="password" id="password-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥å¯†ç¢¼">
        </div>
        <button class="btn" onclick="checkPassword()">ç¢ºèªé€²å…¥</button>
    </div>

    <!-- 1. ç™»å…¥ä»‹é¢ -->
    <div id="login-screen" class="card hidden">
        <h2>å­¸ç”Ÿç™»å…¥</h2>
        <div class="form-group">
            <label>ç­åˆ¥</label>
            <select id="class-select" onchange="handleClassChange()">
                <option value="" disabled selected>è«‹é¸æ“‡</option>
                <option value="1A">1A</option>
                <option value="1B">1B</option>
                <option value="1C">1C</option>
                <option value="1D">1D</option>
                <option value="1E">1E</option>
                <option value="CUSTOM">è‡ªè¨‚</option>
            </select>
        </div>
        <div id="student-group" class="form-group hidden">
            <label>å§“å</label>
            <select id="student-select"></select>
        </div>
        <div id="custom-group" class="form-group hidden">
            <label>è¼¸å…¥å­¸è™ŸåŠå§“å</label>
            <input type="text" id="custom-input" placeholder="ä¾‹å¦‚ï¼š1 é™³å°æ˜">
        </div>

        <button id="start-btn" class="btn" onclick="startAssessment()">é–‹å§‹è©•ä¼°</button>
        <p id="login-msg" style="color: red; margin-top: 10px;"></p>
    </div>

    <!-- 2. è©•ä¼°ä»‹é¢ -->
    <div id="game-screen" class="card hidden">
        <div class="status-bar">
            <span id="student-display"></span>
            <span>éƒ¨åˆ†: <span id="part-display">1</span>/4</span>
        </div>
        
        <h3 class="instruction" id="instruction-text">é¡Œç›®èªªæ˜</h3>

        <div class="play-area" id="play-area">
            <!-- å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <div style="margin-top: 30px;">
            <button class="btn" onclick="checkCurrentPart()">æäº¤ç­”æ¡ˆ</button>
        </div>
    </div>

    <!-- 3. çµæœä»‹é¢ -->
    <div id="result-screen" class="card hidden">
        <h2>è©•ä¼°æˆç¸¾å–®</h2>
        <div id="final-student-info" style="font-size: 1.5em; margin-bottom: 15px; color: #555;"></div>
        <div class="result-score"><span id="total-score">0</span><span style="font-size:0.4em; color:#999;"> / 20</span></div>
        
        <table class="result-table">
            <thead>
                <tr>
                    <th>éƒ¨åˆ†</th>
                    <th>æ»¿åˆ†</th>
                    <th>å¾—åˆ†</th>
                </tr>
            </thead>
            <tbody id="score-details"></tbody>
        </table>

        <!-- è©³ç´°çµæœå€åŸŸ -->
        <div class="details-container">
            <h3 class="details-title">è©³ç´°ç­”é¡Œç´€éŒ„</h3>
            <table class="details-table">
                <thead>
                    <tr>
                        <th>é¡Œç›®å…§å®¹</th>
                        <th>å­¸ç”Ÿç­”æ¡ˆ</th>
                        <th>æ­£ç¢ºç­”æ¡ˆ</th>
                        <th>çµæœ</th>
                    </tr>
                </thead>
                <tbody id="details-body"></tbody>
            </table>
        </div>

        <!-- é–å®šæ§åˆ¶èˆ‡æäº¤ -->
        <div style="margin-top: 30px;">
            <div class="lock-control" style="opacity: 0.8;">
                <label>
                    <input type="checkbox" id="lock-student-checkbox" checked disabled>
                    ğŸ”’ å­¸ç”Ÿå·²é–å®š (æˆç¸¾å·²ä¸Šå‚³)
                </label>
            </div>
            
            <div id="upload-status"></div>
            
            <button id="next-student-btn" class="btn" onclick="resetUI()">ä¸‹ä¸€ä½å­¸ç”Ÿ</button>
        </div>
    </div>

    <!-- å›é¥‹å½ˆçª— -->
    <div id="feedback-modal" class="modal-overlay">
        <div class="modal">
            <div id="modal-icon" style="font-size: 5em; margin-bottom: 20px;"></div>
            <h3 id="modal-title" style="font-size: 2em; margin: 0 0 10px 0;"></h3>
            <p id="modal-msg" style="font-size: 1.5em; color: #666;"></p>
            <button class="btn" onclick="nextPart()">ç¹¼çºŒ</button>
        </div>
    </div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxlO1HvXreL2Lkr0dJuiVOfgA30vQfjvD8dGPZ2AzkdogpEnt_H8LH5JgTN8mLjvwyc/exec"; 
    const STORAGE_KEY = 'science_assessment_data';

    // === å­¸ç”Ÿè³‡æ–™ ===
    const studentData = {
        "1A": [{id:1,name:"é™³ç†¹é›‹"},{id:2,name:"é™³æ„è¡¡"},{id:3,name:"é™³å½¥å›"},{id:4,name:"é™³æ¥šçš“"},{id:5,name:"é™³å½¥ç¾²"},{id:6,name:"ä¾¯æ—è²"},{id:7,name:"è¨±çš“ç³"},{id:8,name:"é»ƒç…œè»’"},{id:9,name:"é—œæ—¨è‡"},{id:10,name:"åŠ‰å“ç€…"},{id:11,name:"åŠ‰ä»²å®‡"},{id:12,name:"ç¾…å“ç†™"},{id:13,name:"æèŠ¯æ‚¦"},{id:14,name:"å‘‚ä¿Šéœ–"},{id:15,name:"å‘‚ä»²è»’"},{id:16,name:"å³è«¾å…’"},{id:17,name:"å½­æ¢“æ‚¦"},{id:18,name:"æ–½éˆæº"},{id:19,name:"å­«å­è±ª"},{id:20,name:"æ›¾ä»¥ä»"},{id:21,name:"æ›¹æ­£"},{id:22,name:"ç‹å¤©å®‡"},{id:23,name:"ç‹æŸè«¾"},{id:24,name:"èƒ¡æ‚¦ç¿¹"}],
        "1B": [{id:1,name:"é™³æ›‰ç‘©"},{id:2,name:"é™³æ¢“éŸœ"},{id:3,name:"é™³æ°¸æ˜‡"},{id:4,name:"é™³æ‚…å¿ƒ"},{id:5,name:"å¼µå³»çƒ½"},{id:6,name:"è”¡å®é‘«"},{id:7,name:"æœ±çå–†"},{id:8,name:"ä½•å…æ’"},{id:9,name:"éŸ“æ¬£ç©"},{id:10,name:"å¶å®‡æ’"},{id:11,name:"æ±Ÿæ³³ç³"},{id:12,name:"é—œæ˜è²"},{id:13,name:"é„ºé›ªæ™´"},{id:14,name:"åŠ‰èŠŠæ±"},{id:15,name:"ç¾…å¾©å¸Œ"},{id:16,name:"æä¿Šéœ†"},{id:17,name:"æé§"},{id:18,name:"æ¢å‡±æ·‡"},{id:19,name:"å·«æ’é€¸"},{id:20,name:"æŸ¯èŠ·æ™´"},{id:21,name:"è˜‡æ™ºæ³“"},{id:22,name:"æ›¾é‹­å½¬"},{id:23,name:"å°¹æ¢“è¨€"},{id:24,name:"èƒ¡æ¢“æ¦£"},{id:25,name:"ä¸˜æ–‡åš"},{id:26,name:"æœ±é‘ ç©"}],
        "1C": [{id:1,name:"æ­é™½å­æœ—"},{id:2,name:"å‘¨æŸæ©‹"},{id:3,name:"é„­æµšæ±"},{id:4,name:"å¼µæ´›é ¤"},{id:5,name:"å¼µå…è¬™"},{id:6,name:"æœ±å–„é‹"},{id:7,name:"æ´ªæ°¸çƒ"},{id:8,name:"è‘‰æ„·æ™´"},{id:9,name:"æ±Ÿæ¾¤æ¥·"},{id:10,name:"æ±Ÿæ³³å©·"},{id:11,name:"éƒ­æ›‰éœ"},{id:12,name:"æ—èŠŠç¥"},{id:13,name:"åŠ‰å­å„€"},{id:14,name:"æå“è«¾"},{id:15,name:"ææŸç¿±"},{id:16,name:"æ¢å¿ƒå·§"},{id:17,name:"æ¢é€¸ç†¹"},{id:18,name:"å±é€¸è¾°"},{id:19,name:"æ½˜æ‰¿éˆ"},{id:20,name:"è•­é›¨å½¤"},{id:21,name:"è­šæ„·ç‘¤"},{id:22,name:"è­šä¸ç«£"},{id:23,name:"ç”°æ™æ½¼"},{id:24,name:"ç‹æ¨‚æ¾„"},{id:25,name:"é»ƒå­è»’"},{id:26,name:"ç‹æ¢“ç„¶"},{id:27,name:"è‘‰èŠ·æ™´"}],
        "1D": [{id:1,name:"é™³æŒ¯è»’"},{id:2,name:"é™³æ™"},{id:3,name:"é™³æŸç†¹"},{id:4,name:"é™³å®ä¿¡"},{id:5,name:"å¼µçç«¥"},{id:6,name:"å‘¨ç¾²å’Œ"},{id:7,name:"å¾æœ—ç"},{id:8,name:"æ–¹ä¿Šç†¹"},{id:9,name:"æ–¹æ¢“å–¬"},{id:10,name:"æ±Ÿå¾½"},{id:11,name:"éƒ­åˆå˜‰"},{id:12,name:"åŠ‰æ·³æµ "},{id:13,name:"æ¢é–å ¯"},{id:14,name:"æç¥‰è«¾"},{id:15,name:"æ—è©©ç©"},{id:16,name:"å»–å¿ƒç‘œ"},{id:17,name:"ç›§æ›‰æ€¡"},{id:18,name:"é¡å­å–„"},{id:19,name:"é„§å…ˆå–»"},{id:20,name:"é„§èŠ·çº"},{id:21,name:"è¬æ³“æ³°"},{id:22,name:"ç«¥è¡å˜‰"},{id:23,name:"é»ƒç…¦æ˜¡"},{id:24,name:"å³å˜‰é‹­"},{id:25,name:"æ¥Šå–„é›¯"},{id:26,name:"å§šèŠŠèª"}],
        "1E": [{id:1,name:"é™³å¸Œéœ–"},{id:2,name:"é™³æ™ç‘œ"},{id:3,name:"é™³å›æ¥­"},{id:4,name:"é™³æº°ç³"},{id:5,name:"é™³æ˜Ÿå®‡"},{id:6,name:"é„­å­æ¦†"},{id:7,name:"é¦®æ™ç«¥"},{id:8,name:"ä½•é‰¦éœ†"},{id:9,name:"è¨±æ­£ç¿¹"},{id:10,name:"éƒ­æŸå¸Œ"},{id:11,name:"éƒ­æŸå–¬"},{id:12,name:"æ—å˜‰æ…§"},{id:13,name:"ç¾…æ•èŠ«"},{id:14,name:"æ¢å¤©è±ª"},{id:15,name:"é€£å°‰ğ§§½"},{id:16,name:"ç›§å¿ƒæ€¡"},{id:17,name:"å‹ä»¥æ›ˆ"},{id:18,name:"è«å½¥åš"},{id:19,name:"æ½˜æŸçš“"},{id:21,name:"è”¡ç«£è»’"},{id:22,name:"é»ƒæ™‰è¬™"},{id:23,name:"é»ƒè©©æ·‡"},{id:24,name:"èƒ¡å‡±è—"},{id:25,name:"é¡å˜‰å¸Œ"},{id:26,name:"æ¥Šæ¨‚è»’"}]
    };

    const svgPillow = `<svg viewBox="0 0 64 64"><rect x="4" y="16" width="56" height="32" rx="10" ry="10" fill="#E3F2FD" stroke="#42A5F5" stroke-width="1.5"/></svg>`;

    const itemDB = {
        soft: [
            {id:'s1', name:'æ•é ­', eng:'Pillow', icon: svgPillow, img: 'æ•é ­ (Pillow).png'},
            {id:'s2', name:'æ£‰èŠ±', eng:'Cotton', icon: '', img: 'æ£‰èŠ± (Cotton).png'},
            {id:'s3', name:'æµ·ç¶¿', eng:'Sponge', icon: '', img: 'æµ·ç¶¿ (Sponge).png'},
            {id:'s4', name:'æ¯›å·¾', eng:'Towel', icon: '', img: 'æ¯›å·¾ (Towel).png'},
            {id:'s5', name:'éºµåŒ…', eng:'Bread', icon: '', img: 'éºµåŒ… (Bread).png'},
            {id:'s6', name:'æ³°è¿ªç†Š', eng:'Teddy Bear', icon: '', img: 'æ³°è¿ªç†Š (Teddy Bear).png'}
        ],
        hard: [
            {id:'h1', name:'çŸ³é ­', eng:'Rock', icon: '', img: 'çŸ³é ­ (Rock).png'},
            {id:'h2', name:'éµéš', eng:'Hammer', icon: '', img: 'éµéš (Hammer).png'},
            {id:'h3', name:'é‘½çŸ³', eng:'Diamond', icon: '', img: 'é‘½çŸ³ (Diamond).png'},
            {id:'h4', name:'æœ¨å¡Š', eng:'Wood Block', icon: '', img: 'æœ¨å¡Š (Wood Block).png'},
            {id:'h5', name:'é–åŒ™', eng:'Key', icon: '', img: 'é–åŒ™ (Key).png'},
            {id:'h6', name:'ç£šé ­', eng:'Brick', icon: '', img: 'ç£šé ­ (Brick).png'}
        ],
        weights: [
            {id:'w1', name:'ç¾½æ¯›', eng:'Feather', icon: '', img: 'ç¾½æ¯› (Feather).png', val:1},
            {id:'w2', name:'è¬å­—å¤¾', eng:'Paper Clip', icon: '', img: 'è¬å­—å¤¾ (Paper Clip).png', val:2},
            {id:'w3', name:'æ¨¹è‘‰', eng:'Leaf', icon: '', img: 'æ¨¹è‘‰ (Leaf).png', val:3},
            {id:'w4', name:'è˜‹æœ', eng:'Apple', icon: '', img: 'è˜‹æœ (Apple).png', val:20},
            {id:'w5', name:'æ›¸æœ¬', eng:'Book', icon: '', img: 'æ›¸æœ¬ (Book).png', val:30},
            {id:'w6', name:'æ°´æ¨½', eng:'Water Bottle', icon: '', img: 'æ°´æ¨½ (Water Bottle).png', val:25},
            {id:'w7', name:'å•éˆ´', eng:'Dumbbell', icon: '', img: 'å•éˆ´ (Dumbbell).png', val:80},
            {id:'w9', name:'ç§å®¶è»Š', eng:'Car', icon: '', img: 'ç§å®¶è»Š (Car).png', val:90}
        ],
        elastic: [
            {id:'e1', name:'æ©¡çš®åœˆ', eng:'Rubber Band', icon: '', img: 'æ©¡çš®åœˆ (Rubber Band).png', type:'yes'},
            {id:'e2', name:'æ°£çƒ', eng:'Balloon', icon: '', img: 'æ°£çƒ (Balloon).png', type:'yes'},
            {id:'e3', name:'å½ˆå¼“', eng:'Slingshot', icon: '', img: 'å½ˆå¼“ (Slingshot).png', type:'yes'},
            {id:'e4', name:'ç­·å­', eng:'Chopsticks', icon: '', img: 'ç­·å­ (Chopsticks).png', type:'no'},
            {id:'e5', name:'ç¡¬å¹£', eng:'Coin', icon: '', img: 'ç¡¬å¹£ (Coin).png', type:'no'},
            {id:'e6', name:'çŸ³é ­', eng:'Rock', icon: '', img: 'çŸ³é ­ (Rock).png', type:'no'}
        ],
        translucent: [
            {id:'t1', name:'ç»ç’ƒæ¯', eng:'Glass Cup', icon: '', img: 'ç»ç’ƒæ¯ (Glass Cup).png', type:'yes'},
            {id:'t2', name:'çœ¼é¡', eng:'Glasses', icon: '', img: 'çœ¼é¡ (Glasses).png', type:'yes'},
            {id:'t3', name:'æ”¾å¤§é¡', eng:'Magnifying Glass', icon: '', img: 'æ”¾å¤§é¡ (Magnifying Glass).png', type:'yes'},
            {id:'t4', name:'æœ¨é–€', eng:'Wooden Door', icon: '', img: 'æœ¨é–€ (Wooden Door).png', type:'no'},
            {id:'t5', name:'æ›¸æœ¬', eng:'Book', icon: '', img: 'æ›¸æœ¬ (Book).png', type:'no'},
            {id:'t6', name:'ç“¦ç…²', eng:'Clay Pot', icon: '', img: 'ç“¦ç…² (Clay Pot).png', type:'no'}
        ]
    };

    let state = {
        student: "",
        studentNameOnly: "", 
        classNo: "", 
        part: 0, 
        imageMode: 'real', 
        scores: { p1:0, p2:0, p3:0, p4:0 },
        currentItems: [],
        droppedItems: {},
        history: [],
        answersData: {}
    };

    // è‡ªå‹•ç™»å…¥æª¢æŸ¥
    window.onload = function() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            try {
                const savedState = JSON.parse(savedData);
                if (savedState.part > 0 || savedState.student) {
                    state = savedState;
                    restoreGameUI();
                }
            } catch (e) {
                console.error("é‚„åŸå¤±æ•—", e);
                localStorage.removeItem(STORAGE_KEY);
            }
        }

        // åŠ å…¥ Enter éµç›£è½ (å¯†ç¢¼)
        const pwdInput = document.getElementById("password-input");
        if(pwdInput) {
            pwdInput.addEventListener("keyup", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault(); 
                    checkPassword();
                }
            });
        }
    };

    function saveProgress() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function logout() {
        if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿé€™å°‡æ¸…é™¤ç›®å‰çš„é€²åº¦ã€‚")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    // é‚„åŸä»‹é¢
    function restoreGameUI() {
        document.getElementById('password-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('logout-btn').style.display = 'block';

        if (state.student) {
            document.getElementById('student-display').innerText = state.student;
        }

        if (state.part >= 1 && state.part <= 4) {
            document.getElementById('game-screen').classList.remove('hidden');
            
            document.getElementById('part-display').innerText = state.part;
            let instr = "";
            if (state.part===1) instr="è«‹å°‡ç‰©å“åˆ†é¡ï¼šè»Ÿçš„æ”¾å·¦é‚Šï¼Œç¡¬çš„æ”¾å³é‚Š (å…±6åˆ†)";
            else if (state.part===2) instr="è«‹ä¾é‡é‡æ’åˆ—ï¼šç”±è¼•è‡³é‡ (å…¨å°å¾—4åˆ†)";
            else if (state.part===3) instr="å“ªäº›æœ‰å½ˆæ€§ï¼Ÿè«‹åˆ†é¡ (å…±6åˆ†)";
            else if (state.part===4) instr="å“ªäº›æœƒé€å…‰ï¼Ÿè«‹åˆ†é¡ (å…±4åˆ†)";
            document.getElementById('instruction-text').innerText = instr;

            if (state.part===2) {
                const area = document.getElementById("play-area");
                area.innerHTML = `
                    <div class="ordering-container">
                        <div class="order-slot" data-slot="0"><span class="slot-label">æœ€è¼•</span></div>
                        <div class="arrow-indicator">â¡</div>
                        <div class="order-slot" data-slot="1"><span class="slot-label">ä¸­é–“</span></div>
                        <div class="arrow-indicator">â¡</div>
                        <div class="order-slot" data-slot="2"><span class="slot-label">æœ€é‡</span></div>
                    </div>
                    <div id="items-pool" class="items-pool"></div>
                `;
            } else {
                let labels = [], types = [];
                if (state.part===1) { labels=['è»Ÿ','ç¡¬']; types=['soft','hard']; }
                else if (state.part===3) { labels=['æœ‰å½ˆæ€§','æ²’æœ‰å½ˆæ€§']; types=['yes','no']; }
                else if (state.part===4) { labels=['é€å…‰','ä¸é€å…‰']; types=['yes','no']; }
                
                const area = document.getElementById("play-area");
                area.innerHTML = `
                    <div class="buckets-container">
                        <div class="bucket" data-type="${types[0]}"><div class="bucket-label">${labels[0]}</div></div>
                        <div class="bucket" data-type="${types[1]}"><div class="bucket-label">${labels[1]}</div></div>
                    </div>
                    <div id="items-pool" class="items-pool"></div>
                `;
            }

            renderItems(state.currentItems);

            for (const [idx, targetType] of Object.entries(state.droppedItems)) {
                const itemEl = document.getElementById(`item-${idx}`);
                if (itemEl) {
                    let targetZone;
                    if (state.part === 2) {
                        targetZone = document.querySelector(`.order-slot[data-slot="${targetType}"]`);
                    } else {
                        targetZone = document.querySelector(`.bucket[data-type="${targetType}"]`);
                    }
                    
                    if (targetZone) {
                        targetZone.appendChild(itemEl);
                        itemEl.classList.add('placed');
                    }
                }
            }
        } else if (state.part > 4) {
            finishAssessment(true); 
        }
    }

    function checkPassword() {
        const pwd = document.getElementById('password-input').value;
        if (pwd === "grandmont") {
            document.getElementById('password-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        } else {
            alert("å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ï¼");
            document.getElementById('password-input').value = ""; 
        }
    }

    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }
    function getRandom(arr, n) {
        return shuffle([...arr]).slice(0, n);
    }

    function handleClassChange() {
        const cls = document.getElementById("class-select").value;
        const sSelect = document.getElementById("student-select");
        const sGroup = document.getElementById("student-group");
        const cGroup = document.getElementById("custom-group");
        
        sSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å­¸ç”Ÿ</option>';
        sGroup.classList.add("hidden");
        cGroup.classList.add("hidden");

        if (cls === "CUSTOM") {
            cGroup.classList.remove("hidden");
        } else if (studentData[cls]) {
            sGroup.classList.remove("hidden");
            const sortedStudents = [...studentData[cls]].sort((a, b) => a.id - b.id);
            sortedStudents.forEach(s => {
                let opt = document.createElement("option");
                opt.value = `${s.id} ${s.name}`;
                opt.text = `${s.id} ${s.name}`;
                sSelect.add(opt);
            });
        }
    }

    function startAssessment() {
        const cls = document.getElementById("class-select").value;
        if (!cls) return alert("è«‹é¸æ“‡ç­åˆ¥");
        
        const btn = document.getElementById("start-btn");
        const loginMsg = document.getElementById("login-msg");
        
        btn.disabled = true;
        btn.innerText = "æª¢æŸ¥ä¸­..."; 
        loginMsg.innerText = "æ­£åœ¨æª¢æŸ¥å­¸ç”Ÿç‹€æ…‹...";

        let fullStudentString = "";
        let classNo = "";
        let studentName = "";

        if (cls === "CUSTOM") {
            fullStudentString = document.getElementById("custom-input").value;
            const parts = fullStudentString.match(/^(\d+)\s+(.+)$/);
            if(parts) {
                classNo = parts[1];
                studentName = parts[2];
            } else {
                classNo = "0"; 
                studentName = fullStudentString;
            }
        } else {
            fullStudentString = document.getElementById("student-select").value;
            if(!fullStudentString) {
                btn.disabled = false;
                btn.innerText = "é–‹å§‹è©•ä¼°";
                loginMsg.innerText = "";
                return alert("è«‹é¸æ“‡å­¸ç”Ÿ");
            }
            const parts = fullStudentString.match(/^(\d+)\s+(.+)$/);
            if(parts) {
                classNo = parts[1];
                studentName = parts[2];
            }
        }

        const runGame = () => {
            state.student = fullStudentString;
            state.classNo = classNo;
            state.studentNameOnly = studentName;
            state.imageMode = 'real';

            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("game-screen").classList.remove("hidden");
            document.getElementById("student-display").innerText = state.student;
            document.getElementById("logout-btn").style.display = 'block';
            saveProgress();
            startPart1();
        };

        const checkUrl = `${GOOGLE_SCRIPT_URL}?class=${cls}&no=${classNo}`;
        
        // å–æ¶ˆé€¾æ™‚æ©Ÿåˆ¶ï¼Œæ”¹ç‚ºç›´æ¥è«‹æ±‚ä¸¦ç­‰å¾…å›æ‡‰
        fetch(checkUrl)
            .then(response => response.json())
            .then(data => {
                if (data.locked) {
                    btn.disabled = false;
                    btn.innerText = "é–‹å§‹è©•ä¼°";
                    loginMsg.innerText = "âŒ æ­¤å­¸ç”Ÿå·²è¢«é–å®šï¼Œç„¡æ³•å†æ¬¡ä½œç­”ã€‚";
                    alert("æ­¤å­¸ç”Ÿå·²è¢«é–å®šï¼Œç„¡æ³•å†æ¬¡ä½œç­”ã€‚è«‹è¯çµ¡è€å¸«è§£é™¤é–å®šã€‚");
                } else {
                    runGame();
                }
            })
            .catch(err => {
                console.error("Lock check failed", err);
                btn.disabled = false;
                btn.innerText = "é–‹å§‹è©•ä¼°";
                loginMsg.innerText = "âš ï¸ ç„¡æ³•é€£æ¥ä¼ºæœå™¨æª¢æŸ¥ç‹€æ…‹ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡ã€‚";
                alert("ç„¡æ³•é€£æ¥ä¼ºæœå™¨æª¢æŸ¥ç‹€æ…‹ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£ç·šã€‚\n(ç‚ºç¢ºä¿å·²é–å®šå­¸ç”Ÿä¸èƒ½é‡åšï¼Œå¿…é ˆé€£ç·šæ‰èƒ½é–‹å§‹)");
            });
    }

    // è‡ªå‹•ä¸Šå‚³å‡½å¼
    function uploadData() {
        const statusDiv = document.getElementById("upload-status");
        
        statusDiv.innerHTML = '<div style="color:#0277BD; font-weight:bold;">â˜ï¸ æ­£åœ¨è‡ªå‹•ä¸Šå‚³æˆç¸¾...</div>';
        
        const total = state.scores.p1 + state.scores.p2 + state.scores.p3 + state.scores.p4;
        const payload = {
            class: document.getElementById("class-select").value,
            classNo: state.classNo,       
            studentName: state.studentNameOnly, 
            totalScore: total,
            scores: state.scores,
            answers: state.answersData,
            isLocked: true 
        };

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            statusDiv.innerHTML = '<div style="color:green; font-weight:bold;">âœ… æˆç¸¾å·²è‡ªå‹•å„²å­˜ä¸¦é–å®šï¼</div>';
            localStorage.removeItem(STORAGE_KEY); 
        }).catch(err => {
            console.error(err);
            statusDiv.innerHTML = '<div style="color:red; font-weight:bold;">âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡ã€‚<button class="btn btn-sm btn-outline-danger" onclick="uploadData()" style="margin-left:10px;">é‡è©¦</button></div>';
        });
    }

    function resetUI() {
        const currentClass = document.getElementById("class-select").value;
        const studentSelect = document.getElementById("student-select");
        const currentIndex = studentSelect.selectedIndex;

        state.part = 0;
        state.scores = { p1:0, p2:0, p3:0, p4:0 };
        state.currentItems = [];
        state.droppedItems = {};
        state.history = [];
        state.answersData = {};
        
        document.getElementById("result-screen").classList.add("hidden");
        document.getElementById("login-screen").classList.remove("hidden");
        document.getElementById("upload-status").innerHTML = ""; 
        document.getElementById("login-msg").innerText = ""; 
        document.getElementById("logout-btn").style.display = 'none'; 
        
        // Reset start button state
        const startBtn = document.getElementById("start-btn");
        startBtn.disabled = false;
        startBtn.innerText = "é–‹å§‹è©•ä¼°";

        const classSelect = document.getElementById("class-select");
        classSelect.value = currentClass;
        handleClassChange(); 
        
        if (currentClass !== "CUSTOM" && currentIndex > 0) {
            const nextIndex = currentIndex + 1;
            const newStudentSelect = document.getElementById("student-select");
            if (nextIndex < newStudentSelect.options.length) {
                newStudentSelect.selectedIndex = nextIndex;
            } else {
                newStudentSelect.selectedIndex = 0; 
            }
        } else {
            document.getElementById("student-select").value = "";
            document.getElementById("custom-input").value = "";
        }
    }

    function startPart1() {
        state.part = 1;
        document.getElementById("part-display").innerText = "1";
        document.getElementById("instruction-text").innerText = "è«‹å°‡ç‰©å“åˆ†é¡ï¼šè»Ÿçš„æ”¾å·¦é‚Šï¼Œç¡¬çš„æ”¾å³é‚Š (å…±6åˆ†)";
        
        const softs = getRandom(itemDB.soft, 3).map(i => ({...i, type:'soft'}));
        const hards = getRandom(itemDB.hard, 3).map(i => ({...i, type:'hard'}));
        state.currentItems = shuffle([...softs, ...hards]);
        state.droppedItems = {};
        saveProgress(); 

        renderBuckets(['è»Ÿ', 'ç¡¬'], ['soft', 'hard']);
        renderItems(state.currentItems);
    }

    function startPart2() {
        state.part = 2;
        document.getElementById("part-display").innerText = "2";
        document.getElementById("instruction-text").innerText = "è«‹ä¾é‡é‡æ’åˆ—ï¼šç”±è¼•è‡³é‡ (å…¨å°å¾—4åˆ†)";

        const i1 = getRandom(itemDB.weights.slice(0,3), 1)[0];
        const i2 = getRandom(itemDB.weights.slice(3,6), 1)[0];
        const i3 = getRandom(itemDB.weights.slice(6,8), 1)[0];
        state.currentItems = shuffle([i1, i2, i3]);
        state.droppedItems = {};
        saveProgress(); 

        const area = document.getElementById("play-area");
        area.innerHTML = `
            <div class="ordering-container">
                <div class="order-slot" data-slot="0"><span class="slot-label">æœ€è¼•</span></div>
                <div class="arrow-indicator">â¡</div>
                <div class="order-slot" data-slot="1"><span class="slot-label">ä¸­é–“</span></div>
                <div class="arrow-indicator">â¡</div>
                <div class="order-slot" data-slot="2"><span class="slot-label">æœ€é‡</span></div>
            </div>
            <div id="items-pool" class="items-pool"></div>
        `;
        renderItems(state.currentItems);
    }

    function startPart3() {
        state.part = 3;
        document.getElementById("part-display").innerText = "3";
        document.getElementById("instruction-text").innerText = "å“ªäº›æœ‰å½ˆæ€§ï¼Ÿè«‹åˆ†é¡ (å…±6åˆ†)";

        state.currentItems = getRandom(itemDB.elastic, 3);
        state.droppedItems = {};
        saveProgress(); 

        renderBuckets(['æœ‰å½ˆæ€§', 'æ²’æœ‰å½ˆæ€§'], ['yes', 'no']);
        renderItems(state.currentItems);
    }

    function startPart4() {
        state.part = 4;
        document.getElementById("part-display").innerText = "4";
        document.getElementById("instruction-text").innerText = "å“ªäº›æœƒé€å…‰ï¼Ÿè«‹åˆ†é¡ (å…±4åˆ†)";

        state.currentItems = getRandom(itemDB.translucent, 2);
        state.droppedItems = {};
        saveProgress(); 

        renderBuckets(['é€å…‰', 'ä¸é€å…‰'], ['yes', 'no']);
        renderItems(state.currentItems);
    }

    function renderBuckets(labels, types) {
        const area = document.getElementById("play-area");
        area.innerHTML = `
            <div class="buckets-container">
                <div class="bucket" data-type="${types[0]}"><div class="bucket-label">${labels[0]}</div></div>
                <div class="bucket" data-type="${types[1]}"><div class="bucket-label">${labels[1]}</div></div>
            </div>
            <div id="items-pool" class="items-pool"></div>
        `;
    }

    function renderItems(items) {
        const pool = document.getElementById("items-pool");
        items.forEach((item, idx) => {
            const el = document.createElement("div");
            el.className = "draggable";
            el.draggable = false; 
            el.id = `item-${idx}`;
            el.dataset.idx = idx;

            const flatIcon = (item.icon || '').replace(/\s+/g, ' ').trim();
            const htmlSafeIcon = flatIcon.replace(/"/g, '&quot;');
            let iconContent = `<img src="images/${item.img}" alt="${item.name}" draggable="false" onerror="this.onerror=null;this.parentElement.innerHTML='${htmlSafeIcon}';">`; 

            el.innerHTML = `
                <div class="draggable-icon">${iconContent}</div>
                <div class="item-text-container">
                    <div class="item-name">${item.name}</div>
                    <div class="item-eng">${item.eng}</div>
                </div>
            `;
            
            el.addEventListener("touchstart", handleTouchStart, {passive: false});
            el.addEventListener("touchmove", handleTouchMove, {passive: false});
            el.addEventListener("touchend", handleTouchEnd);
            el.addEventListener("mousedown", handleMouseDown);

            pool.appendChild(el);
        });
    }

    let activeDrag = null;
    let startX, startY;
    let currentDroppable = null;
    let originalParent = null; 

    function handleTouchStart(e) {
        e.preventDefault(); 
        const touch = e.touches[0];
        startDrag(e.currentTarget, touch.clientX, touch.clientY);
    }

    function handleMouseDown(e) {
        e.preventDefault();
        startDrag(e.currentTarget, e.clientX, e.clientY);
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    }

    function startDrag(el, clientX, clientY) {
        if (el.classList.contains('placed')) {
            el.classList.remove('placed');
        }

        activeDrag = el;
        activeDrag.classList.add('dragging');
        originalParent = el.parentElement; 
        
        activeDrag.dataset.startX = clientX;
        activeDrag.dataset.startY = clientY;
        activeDrag.dataset.currentTx = 0;
        activeDrag.dataset.currentTy = 0;
    }

    function handleTouchMove(e) {
        if (!activeDrag) return;
        e.preventDefault();
        const touch = e.touches[0];
        moveDrag(touch.clientX, touch.clientY);
    }

    function onMouseMove(e) {
        if (!activeDrag) return;
        moveDrag(e.clientX, e.clientY);
    }

    function moveDrag(clientX, clientY) {
        const dx = clientX - parseFloat(activeDrag.dataset.startX);
        const dy = clientY - parseFloat(activeDrag.dataset.startY);
        
        activeDrag.style.transform = `translate(${dx}px, ${dy}px) scale(1.1)`;
        activeDrag.dataset.currentTx = dx;
        activeDrag.dataset.currentTy = dy;

        activeDrag.style.display = 'none';
        let elemBelow = document.elementFromPoint(clientX, clientY);
        activeDrag.style.display = ''; 

        if (!elemBelow) return;

        let droppableBelow = elemBelow.closest('.bucket, .order-slot');
        
        if (currentDroppable != droppableBelow) {
            if (currentDroppable) {
                currentDroppable.classList.remove('active-drop');
            }
            currentDroppable = droppableBelow;
            if (currentDroppable) {
                currentDroppable.classList.add('active-drop');
            }
        }
    }

    function handleTouchEnd(e) {
        endDrag();
    }

    function onMouseUp(e) {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        endDrag();
    }

    function endDrag() {
        if (!activeDrag) return;
        
        activeDrag.classList.remove('dragging');
        
        if (currentDroppable) {
            currentDroppable.classList.remove('active-drop');
            
            if (state.part === 2 && currentDroppable.children.length > 1 && currentDroppable !== originalParent) {
                placeItem(activeDrag, originalParent);
            } else {
                placeItem(activeDrag, currentDroppable);
            }
        } else {
            returnToPool(activeDrag);
        }

        activeDrag = null;
        currentDroppable = null;
        originalParent = null;
        saveProgress(); 
    }

    function returnToPool(el) {
        const pool = document.getElementById("items-pool");
        el.style.transform = ''; 
        el.classList.remove("placed");
        pool.appendChild(el);
        delete state.droppedItems[el.dataset.idx];
    }

    function placeItem(el, targetZone) {
        el.style.transform = ''; 
        targetZone.appendChild(el);
        el.classList.add("placed");
        
        const itemIdx = el.dataset.idx;
        if (targetZone.id === "items-pool") {
             returnToPool(el); 
             return;
        }

        if (state.part === 2) {
            state.droppedItems[itemIdx] = targetZone.dataset.slot;
        } else {
            state.droppedItems[itemIdx] = targetZone.dataset.type;
        }
    }

    function getLabel(part, key) {
        if (part === 1) return key === 'soft' ? 'è»Ÿ' : 'ç¡¬';
        if (part === 2) return key == 0 ? 'æœ€è¼•' : (key == 1 ? 'ä¸­é–“' : 'æœ€é‡');
        if (part === 3) return key === 'yes' ? 'æœ‰å½ˆæ€§' : 'æ²’æœ‰å½ˆæ€§';
        if (part === 4) return key === 'yes' ? 'é€å…‰' : 'ä¸é€å…‰';
        return key;
    }

    function getPartName(part) {
        if (part === 1) return "è»Ÿç¡¬è¾¨åˆ¥";
        if (part === 2) return "è¼•é‡æ’åº";
        if (part === 3) return "å½ˆæ€§è¾¨åˆ¥";
        if (part === 4) return "é€å…‰è¾¨åˆ¥";
        return "";
    }

    function checkCurrentPart() {
        if (Object.keys(state.droppedItems).length < state.currentItems.length) {
            alert("è«‹å°‡æ‰€æœ‰ç‰©å“åˆ†é¡æˆ–æ’åºï¼");
            return;
        }

        let score = 0;
        let msg = "";
        let partHistory = [];

        if (state.part === 1) { 
            state.currentItems.forEach((item, idx) => {
                const ans = state.droppedItems[idx];
                const isCorrect = ans === item.type;
                if (isCorrect) score += 1;
                
                partHistory.push({
                    item: item.name,
                    studentAns: getLabel(1, ans),
                    correctAns: getLabel(1, item.type),
                    isCorrect: isCorrect
                });
            });
            state.scores.p1 = score;
            msg = `æœ¬éƒ¨åˆ†å¾—åˆ†ï¼š${score} / 6`;
        
        } else if (state.part === 2) { 
            const sortedItems = [...state.currentItems].sort((a,b) => a.val - b.val);
            let isAllCorrect = true;
            for(let i=0; i<3; i++) {
                const placedItemIdx = Object.keys(state.droppedItems).find(key => state.droppedItems[key] == i);
                if (placedItemIdx === undefined) { isAllCorrect = false; break; }
                const item = state.currentItems[placedItemIdx];
                const targetItem = sortedItems[i]; 
                
                if (item.val !== targetItem.val) isAllCorrect = false;
            }

            partHistory = state.currentItems.map((item, idx) => {
                const userSlot = state.droppedItems[idx];
                const correctSlotIndex = sortedItems.findIndex(sItem => sItem.id === item.id);
                
                return {
                    item: item.name,
                    studentAns: getLabel(2, userSlot),
                    correctAns: getLabel(2, correctSlotIndex), 
                    isCorrect: isAllCorrect 
                };
            });

            if (isAllCorrect) score = 4;
            state.scores.p2 = score;
            msg = isAllCorrect ? "å…¨å°ï¼å¤ªå²å®³äº†ï¼ (4åˆ†)" : "é †åºä¸å°å–”ï¼Œå†æ¥å†å²ï¼ (0åˆ†)";

        } else if (state.part === 3) { 
            state.currentItems.forEach((item, idx) => {
                const ans = state.droppedItems[idx];
                const isCorrect = ans === item.type;
                if (isCorrect) score += 2;
                partHistory.push({
                    item: item.name,
                    studentAns: getLabel(3, ans),
                    correctAns: getLabel(3, item.type),
                    isCorrect: isCorrect
                });
            });
            state.scores.p3 = score;
            msg = `æœ¬éƒ¨åˆ†å¾—åˆ†ï¼š${score} / 6`;

        } else if (state.part === 4) { 
            state.currentItems.forEach((item, idx) => {
                const ans = state.droppedItems[idx];
                const isCorrect = ans === item.type;
                if (isCorrect) score += 2;
                partHistory.push({
                    item: item.name,
                    studentAns: getLabel(4, ans),
                    correctAns: getLabel(4, item.type),
                    isCorrect: isCorrect
                });
            });
            state.scores.p4 = score;
            msg = `æœ¬éƒ¨åˆ†å¾—åˆ†ï¼š${score} / 4`;
        }

        state.history.push({
            partName: getPartName(state.part),
            details: partHistory
        });
        saveProgress(); 

        showModal(score > 0 ? "ğŸ‰ å®Œæˆï¼" : "ğŸ’ª åŠ æ²¹ï¼", msg);
    }

    function showModal(title, msg) {
        document.getElementById("modal-title").innerText = title;
        document.getElementById("modal-msg").innerText = msg;
        document.getElementById("feedback-modal").style.display = "flex";
    }

    function nextPart() {
        document.getElementById("feedback-modal").style.display = "none";
        if (state.part === 1) startPart2();
        else if (state.part === 2) startPart3();
        else if (state.part === 3) startPart4();
        else finishAssessment();
    }

    function finishAssessment(isRestore = false) {
        state.part = 5; 
        if(!isRestore) {
            saveProgress();
            // è‡ªå‹•ä¸Šå‚³
            uploadData();
        }

        document.getElementById("game-screen").classList.add("hidden");
        document.getElementById("result-screen").classList.remove("hidden");
        
        const total = state.scores.p1 + state.scores.p2 + state.scores.p3 + state.scores.p4;
        document.getElementById("total-score").innerText = total;
        document.getElementById("final-student-info").innerText = state.student;
        const tbody = document.getElementById("score-details");
        tbody.innerHTML = `
            <tr><td>1. è»Ÿç¡¬åˆ†è¾¨</td><td>6</td><td>${state.scores.p1}</td></tr>
            <tr><td>2. è¼•é‡æ’åº</td><td>4</td><td>${state.scores.p2}</td></tr>
            <tr><td>3. å½ˆæ€§è¾¨åˆ¥</td><td>6</td><td>${state.scores.p3}</td></tr>
            <tr><td>4. é€å…‰è¾¨åˆ¥</td><td>4</td><td>${state.scores.p4}</td></tr>
        `;

        const detailsBody = document.getElementById("details-body");
        let detailsHTML = "";
        let answersData = { p1: "", p2: "", p3: "", p4: "" };

        state.history.forEach((section, index) => {
            detailsHTML += `<tr><td colspan="4" style="background:#eee; font-weight:bold;">${section.partName}</td></tr>`;
            let partAnsStr = "";
            section.details.forEach(q => {
                const statusClass = q.isCorrect ? "ans-correct" : "ans-wrong";
                const statusText = q.isCorrect ? "â­• æ­£ç¢º" : "âŒ éŒ¯èª¤";
                detailsHTML += `
                    <tr>
                        <td>${q.item}</td>
                        <td>${q.studentAns}</td>
                        <td>${q.correctAns}</td>
                        <td class="${statusClass}">${statusText}</td>
                    </tr>
                `;
                partAnsStr += `${q.item}:${q.studentAns}(${q.isCorrect?'O':'X'}), `;
            });
            if (index === 0) answersData.p1 = partAnsStr;
            if (index === 1) answersData.p2 = partAnsStr;
            if (index === 2) answersData.p3 = partAnsStr;
            if (index === 3) answersData.p4 = partAnsStr;
        });
        detailsBody.innerHTML = detailsHTML;
        
        state.answersData = answersData; 
        document.getElementById("lock-student-checkbox").checked = true;
        document.getElementById("lock-student-checkbox").disabled = true;
    }

</script>
</body>
</html>

